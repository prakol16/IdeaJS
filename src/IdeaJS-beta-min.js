(function(){var k,D,Q,h,J,W,M,K,C,x,F,G,R,X,E,L,S,B,N,T,r,q,t,O,U,Y,Z,m,$,z,aa,l,ba,v,V,ea={}.hasOwnProperty,ca=function(b,a){function e(){this.constructor=b}for(var c in a)ea.call(a,c)&&(b[c]=a[c]);e.prototype=a.prototype;b.prototype=new e;b.__super__=a.prototype;return b},y=[].indexOf||function(b){for(var a=0,e=this.length;a<e;a++)if(a in this&&this[a]===b)return a;return-1},P=[].slice;if("undefined"===typeof jQuery||null===jQuery)throw Error("jQuery is not defined");k=jQuery;B=function(b,a){null==
a&&(a=!1);if(a)throw Error(b);"undefined"!==typeof console&&null!==console&&"function"===typeof console.error&&console.error(b)};V=function(b){return"undefined"!==typeof console&&null!==console?"function"===typeof console.warn?console.warn(b):void 0:void 0};Q=function(b){function a(a){var c,b,f;b=0;for(f=a.length;b<f;b++)c=a[b],this.push(c)}ca(a,b);a.prototype.on=function(){var a,c,b;c=0;for(b=this.length;c<b;c++)a=this[c],a.on.apply(a,arguments);return this};a.prototype.off=function(){var a,c,b;
c=0;for(b=this.length;c<b;c++)a=this[c],a.off.apply(a,arguments);return this};a.prototype.unbindCollision=function(){var a,c,b;c=0;for(b=this.length;c<b;c++)a=this[c],a.unbindCollision.apply(a,arguments);return this};a.prototype.collides=function(){var a,c,b;c=0;for(b=this.length;c<b;c++)a=this[c],a.collides.apply(a,arguments);return this};return a}(Array);h=function(b,a,e,c){var d,f,g,p,s,A,u,H,I;p=k.type(b);d=k.type(a);g=/^(?:\d,?)+$/;if(0<=y.call(C,b)&&0<=y.call(x,a))return a.allInstances[b.objectId];
if(0<=y.call(C,b)&&("undefined"===d||"current"===a))return h(b,m);if("undefined"===p||"null"===p)return C;if("number"===p&&"undefined"===d)return C[b];if("number"===p&&"current"===a)return h(h(b));if("number"===p&&0<=y.call(x,a))return h(h(b),a);if("string"===p)switch(b){case "iterate":return h.apply(["iterate forward"].concat([].slice.call(arguments,1)));case "iterate forward":d=h(a,e);u=[];p=0;for(s=d.length;p<s;p++)g=d[p],u.push(c.call(g));return u;case "iterate backward":d=h(a,e);u=[];for(f=p=
s=d.length;0>=s?0>p:0<p;f=0>=s?++p:--p)g=d[f-1],u.push(c.call(g));return u;default:if(g.test(b)){if("undefined"===d)return d=function(){var a,s,c,p;c=b.split(",");p=[];a=0;for(s=c.length;a<s;a++)f=c[a],p.push(h(parseInt(f,10)));return p}(),new Q(d);if("current"===a||0<=y.call(x,a)){d=function(){var a,s,c,p;c=b.split(",");p=[];a=0;for(s=c.length;a<s;a++)f=c[a],p.push(parseInt(f,10));return p}();p=new J;s=0;for(u=d.length;s<u;s++)for(g=d[s],I=h(g,a),A=0,H=I.length;A<H;A++)g=I[A],p.push(g);return p}}else{if("string"===
p&&"undefined"===d){d=E[b];if(null==d){z.suppressTagWarnings||B("Bad tag name");break}return new Q(d)}if("string"===p&&("current"===a||0<=y.call(x,a))){d=E[b];null==d&&(z.suppressTagWarnings||B("Bad tag name"));p=new J;u=0;for(s=d.length;u<s;u++)for(g=d[u],I=h(g,a),H=0,A=I.length;H<A;H++)g=I[H],p.push(g);return p}return B("Unrecognizable arguments",!0)}}};h.version="beta";N=function(b){var a,e;a="space;page up;page down;end;home;left;up;right;down".split(";");e=function(){switch(b){case 8:return"backspace";
case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"ctrl";case 18:return"alt";case 20:return"caps lock";case 27:return"esc";case 45:return"insert";case 46:return"delete";case 188:return",";case 190:return".";case 191:return"/";case 192:return"`";case 219:return"[";case 220:return"\\";case 222:return"'";default:return null}}();e||(32<=b&&40>=b&&(e=a[b-32]),48<=b&&57>=b&&(e=b-48+""),65<=b&&90>=b&&(e="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[b-65]),112<=b&&123>=b&&(e="f"+(b-111)));return e};
m=null;v=!1;G=T=r=q=t=null;E={};O=[];W=function(){function b(a){this.selector=a;O.push(this);this.buffer={}}b.prototype.on=function(a,b,c){var d,f;f=this.selector;d=this.buffer;null==d[f]&&(d[f]=[]);d[f].push([a,b,c]);return this};return b}();h.module=function(b){return new W(b)};J=function(b){function a(){a.__super__.constructor.apply(this,arguments)}var e,c,d,f,g;ca(a,b);a.prototype.attr=function(a,s){var c,b,e;if(null!=s||"object"===k.type(a)){b=0;for(e=this.length;b<e;b++)c=this[b],c.attr.apply(c,
arguments);return this}return(c=this[0]).attr.apply(c,arguments)};c="x;y;vx;vy;useBackCan;deactivateOut;sprite;create;begin step;draw;step;end step;events;collision;visible".split(";");b="trigger destroy moveUp moveDown moveRight moveLeft fourDirections animate".split(" ");d=function(c){Object.defineProperty(a.prototype,c,{set:function(a){var b,e,d;e=0;for(d=this.length;e<d;e++)b=this[e],b[c]=a},get:function(a){var b;return null!=(b=this[0])?b[c]:void 0}})};f=0;for(g=c.length;f<g;f++)e=c[f],d(e);
c=function(c){a.prototype[c]=function(){var a,b,e;b=0;for(e=this.length;b<e;b++)a=this[b],a[c].apply(a,arguments);return this}};d=0;for(f=b.length;d<f;d++)e=b[d],c(e);return a}.call(this,Array);h.init=function(b,a,e,c){var d,f,g,p;null==e&&(e=!1);null==c&&(c="body");e?(k(c).css({position:"absolute",width:b,height:a}),t=k(c)[0],v=!0):(p=k("<canvas width="+b+" height="+a+">").css({position:"absolute","z-index":0}),e=k("<canvas width="+b+" height="+a+">").css({position:"absolute","z-index":-1}),k(c).append(e).append(p),
v=!1,c=[p[0],e[0]],t=c[0],G=c[1]);b=[b,a];q=b[0];r=b[1];(function(){var a,c,p,b,e;a=0;p=["ms","moz","webkit","o"];b=0;for(e=p.length;b<e;b++){c=p[b];if(window.requestAnimationFrame)break;window.requestAnimationFrame=window[c+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c+"CancelAnimationFrame"]||window[c+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)return window.requestAnimationFrame=function(c,p){var b,e,A;b=(new Date).getTime();A=Math.max(0,16-(b-a));e=window.setTimeout(function(){return c(b+
A)},A);a=b+A;return e},window.cancelAnimationFrame=function(a){return clearTimeout(a)}})();d=f=0;g=Date.now();X();a=0;for(c=x.length;a<c;a++)b=x[a],b.renderBackPic();return T={play:function(){var a,c,p,b,e,k,n,w,l,r,q,t=this;n=0;for(l=O.length;n<l;n++)for(b in c=O[n],q=c.buffer,q)if(k=q[b],c.buffer.hasOwnProperty(b))for(p=h(b),w=0,r=k.length;w<r;w++)e=k[w],p.on.apply(p,e);a=function(){var c,p;f=requestAnimationFrame(a);return h.assetsLoaded===F.length?(t.loaded||(t.loaded=!0,t.finishLoad()),null!=
m&&m.refresh(),R(),p=1E3/((c=Date.now())-g),d+=(p-d)/50,g=c):t.load(h.assetsLoaded/F.length)};return f=requestAnimationFrame(a)},fps:function(){return d!==d?d=60:d},pause:function(){return cancelAnimationFrame(f)},load:function(a){var c,p,b;c=t.getContext("2d");c.save();c.fillStyle=z.loadColor;c.strokeStyle=z.loadColor;p=q/2-50;b=r/2-25;c.fillRect(p,b,100*a,50);c.strokeRect(p,b,100,50);return c.restore()},finishLoad:function(){return null!=m?"function"===typeof m.refreshBackground?m.refreshBackground():
void 0:void 0},loaded:!1}};h.game=function(){return T};h.settings=z={bufferDestroy:!0,bufferRoomGoto:!0,suppressAudioWarnings:!1,suppressTagWarnings:!1,suppressAlarmWarnings:!1,loadColor:"red"};h.controls=S={keyControls:function(b,a){return k(document).keydown(b).keyup(a)},mouseControls:function(b,a,e){return k(t).mousedown(b).mouseup(a).mousemove(e)}};h.support=aa={audio:"Audio"in window,canvas:null!=(null!=(D=document.createElement("canvas"))?D.tagName:void 0)?!0:!1};h.getScreen=function(){return t};
h.getCanvasContext=function(){return"function"===typeof t.getContext?t.getContext("2d"):void 0};h.getBackCanContext=function(){return"function"===typeof G.getContext?G.getContext("2d"):void 0};h.getBackgroundCanvas=function(){return G};h.gameWidth=function(){return q};h.gameHeight=function(){return r};h.defineSettings=function(b){return k.extend(z,b)};h.allObjects=C=[];l=function(){var b,a,e,c,d,f,g;a=arguments[0];e=arguments[1];b=3<=arguments.length?P.call(arguments,2):[];c=a[e];switch(k.type(c)){case "function":return c.apply(a,
b);case "array":g=[];d=0;for(f=c.length;d<f;d++)e=c[d],g.push(e.apply(a,b));return g;default:return!1}};ba=function(){var b,a,e,c,d,f,g;a=arguments[0];c=arguments[1];b=3<=arguments.length?P.call(arguments,2):[];switch(k.type(c)){case "function":return c.apply(a,b);case "array":g=[];d=0;for(f=c.length;d<f;d++)e=c[d],g.push(e.apply(a,b));return g;default:return!1}};h.gameObject=function(b,a){var e;null==a&&(a=[]);0>y.call(a,"*")&&a.push("*");e=function(a,b,e,g,p){var s;s=2*(e/360)*Math.PI;e=g+(a-g)*
Math.cos(2*Math.PI-s)+(b-p)*Math.sin(2*Math.PI-s);a=p-(a-g)*Math.sin(2*Math.PI-s)+(b-p)*Math.cos(2*Math.PI-s);return[e,a]};return function(){function c(a,b){var e,d,g,k;null!=(e=this.sprite)&&e.useDom&&(this.statics=this.useBackCan=!1);null!=(d=this.sprite)&&d.createDiv();null==this.width&&(this.width=null!=(g=this.sprite)?g.width:void 0);null==this.height&&(this.height=null!=(k=this.sprite)?k.height:void 0);this.statics&&(this.useBackCan=this.deactivateOut=!0);m.allInstances[c.objectId].push(this);
this.useBackCan&&m.staticInst.push(this);this.animQueue=[];this.currentQueue=0;this.constructor=c;this.prevX=this.x=a;this.prevY=this.y=b;this.vx=this.vy=0;this.created=!1;this.imgAngle=0;this.imgScaleX=this.imgScaleY=1;this.id=m.allInstances[c.objectId].length}var d,f,g;c.prototype.statics=!1;c.prototype.sprite=null;c.prototype.visible=!0;c.prototype.width=null;c.prototype.deactivateOut=!1;c.prototype.useBackCan=!1;c.prototype.deactivateOut=!1;c.prototype.visible=!0;c.prototype.animate=function(a,
c){null==c&&(c=200);this.animQueue.push([a,c]);return this};c.prototype.attr=function(a,c){var b;if(null!=c&&"string"===k.type(a))return this[a]=c,this;if("object"===k.type(a)){for(b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);return this}return this[a]};c.prototype.nullified=!1;c.prototype.destroy=function(a){var c,b;null==a&&(a=z.bufferDestroy);a?m.toDestroy.push(this):(a=this.constructor,null!=(c=this.sprite)&&c.useDom&&null!=(b=k(".divSprite"+this.sprite.id+":eq("+(this.id-1)+")"))&&b.remove(),a=
h(a,m),c=a.indexOf(this),0<=y.call(m.staticInst,this)&&(b=m.staticInst.indexOf(this),m.staticInst.splice(b,1)),a.splice(c,1))};c.prototype.mask=function(){var a,c,b,d,g,k;if(0===this.imgAngle)return{x:this.x,y:this.y,width:this.width,height:this.height};a=e(this.x,this.y,this.imgAngle,this.x+this.width/2,this.y+this.height/2);c=e(this.x+this.width,this.y+this.height,this.imgAngle,this.x+this.width/2,this.y+this.height/2);b=e(this.x,this.y+this.height,this.imgAngle,this.x+this.width/2,this.y+this.height/
2);d=e(this.x+this.height,this.y,this.imgAngle,this.x+this.width/2,this.y+this.height/2);g=Math.min(a[0],c[0],b[0],d[0]);k=Math.min(a[1],c[1],b[1],d[1]);return{x:g,y:k,width:Math.max(a[0],c[0],b[0],d[0])-g,height:Math.max(a[1],c[1],b[1],d[1])-k}};c.prototype.moveUp=function(){var a;(a=this.constructor).moveUp.apply(a,arguments);return this};c.prototype.moveDown=function(){var a;(a=this.constructor).moveDown.apply(a,arguments);return this};c.prototype.moveLeft=function(){var a;(a=this.constructor).moveLeft.apply(a,
arguments);return this};c.prototype.moveRight=function(){var a;(a=this.constructor).moveRight.apply(a,arguments);return this};c.prototype.fourDirections=function(){var a;(a=this.constructor).fourDirections.apply(a,arguments);return this};c.prototype.stopMovement=function(){this.vx=this.vy=0;this.x=this.prevX;return this.y=this.prevY};c.prototype.glideTo=function(a,c,b){var e,d,g;null==b&&(b=1);d=[this.x,this.y];e=d[0];d=d[1];a=e-a;c=d-c;b=Math.sqrt((a*a+c*c)/(b*b));return g=[a/b,c/b],this.vx=g[0],
this.vy=g[1],g};c.prototype.draw=function(a){var c,b;null!=(c=this.sprite)&&c.draw(a,this.x,this.y,this.id);return null!=(b=this.sprite)?b.refreshAnimation(m.allInstances[this.constructor.objectId][0]===this):void 0};c.prototype.collision={};c.prototype.direction=function(a,c){null==a&&(a=this.vx);null==c&&(c=this.vy);return(180*Math.atan2(c,a)/Math.PI+360)%360%360};c.prototype.speed=function(a,c){null==a&&(a=this.vx);null==c&&(c=this.vy);return Math.sqrt(a*a+c*c)};c.prototype.trigger=function(){return l.apply(null,
[this].concat(P.call(arguments)))};c.prototype.events=function(){var a,b,e,d,g,f,da,n=this;this.created||(this.created=!0,l(this,"create"));l(this,"begin step");v||(b=t.getContext("2d"));this.visible=d=L(this.mask(),function(){var a;a=m.view();return{x:a[0],y:a[1],width:q,height:r}}());if(!d&&this.deactivateOut)m.deactivated.push(this),a=h(c,m),e=a.indexOf(this),a.splice(e,1),this.sprite.useDom&&k(".divSprite"+this.sprite.id+":eq("+(this.id-1)+")").css("display","none");else{d&&this.deactivateOut&&
v&&k(".divSprite"+this.sprite.id+":eq("+(this.id-1)+")").css("display","block");null==this.draw||this.useBackCan||(v?l(this,"draw",t):(b.save(),b.translate(this.x+this.width/2,this.y+this.height/2),b.rotate(this.imgAngle*Math.PI/180),b.scale(this.imgScaleX,this.imgScaleY),b.translate(-(this.x+this.width/2),-(this.y+this.height/2)),l(this,"draw",b),b.restore()));if(this.nullified)return!1;l(this,"step");if(f=this.animQueue[0]){d=f[0];b=f[1];for(a in d)da=d[a],this[a]+=(da-this[a])/b,0.001>Math.abs(this[a]-
d[a])&&delete d[a];f[1]--;k.isEmptyObject(f[0])&&this.animQueue.splice(0,1)}for(e in null!=(g=this.collision)?g:{})if(this.collision.hasOwnProperty(e))for(a=C[parseInt(e,10)],f=m.allInstances[a.objectId],b=0,d=f.length;b<d;b++)g=f[b],g.nullified||(a=L(g.mask(),this.mask()))&&ba(this,this.collision[e],g,a);n.x+n.width>m.w&&l(n,"intersect boundary","right");n.y+n.height>m.h&&l(n,"intersect boundary","bottom");0>n.x&&l(n,"intersect boundary","left");0>n.y&&l(n,"intersect boundary","top");n.x>m.w&&l(n,
"outside room","right");0>n.x+n.width&&l(n,"outside room","left");n.y>m.h&&l(n,"outside room","bottom");0>n.y+n.height&&l(n,"outside room","top");(function(){var a;a={x:m.view()[0],y:m.view()[1],left:m.view()[0]+q,bottom:m.view()[1]+r};n.x+n.width>a.left&&l(n,"intersect view","right");n.y+n.height>a.bottom&&l(n,"intersect view","bottom");n.x<a.x&&l(n,"intersect view","left");n.y<a.y&&l(n,"intersect view","top");n.x>a.w&&l(n,"outside view","right");n.x+n.width<a.x&&l(n,"outside view","left");n.y>a.bottom&&
l(n,"outside view","bottom");if(n.y+n.height<a.y)return l(n,"outside view","top")})();b=h.globalKeysdown;a=0;for(g=b.length;a<g;a++)e=b[a],l(this,"keydown-"+N(e));b=h.globalKeysup;a=0;for(g=b.length;a<g;a++)e=b[a],l(this,"keyup-"+N(e));b=h.globalKeyspressed;a=0;for(g=b.length;a<g;a++)e=b[a],l(this,"keypressed-"+N(e));h.globalMousedown&&l(this,"mousedown-"+h.globalMousedown);h.globalMousepressed&&l(this,"mousepressed-"+h.globalMousepressed);h.globalMouseup&&l(this,"mouseup-"+h.globalMouseup);this.prevX=
this.x;this.prevY=this.y;this.x+=this.vx;this.y+=this.vy;l(this,"end step")}};C.push(c);c.objectId=C.length-1;x.forEach(function(a,c,b){return b[c].allInstances.push(new J)});f=0;for(g=a.length;f<g;f++)d=a[f],null!=E[d]?E[d].push(c):E[d]=[c];c.on=function(a,c,b){var e,d,g,f,n,w,l;null==b&&(b=!1);a=a.split(", ");g=0;for(n=a.length;g<n;g++)if(e=a[g],0===e.indexOf("collision-with-"))e=e.slice(15),this.collides(e,c,b);else if(d=this.prototype[e],null==d||b?this.prototype[e]=c:"function"===k.type(d)?this.prototype[e]=
[d,c]:"array"===k.type(d)&&d.push(c),null!=m)for(l=h(this,"current"),f=0,w=l.length;f<w;f++)d=l[f],d.hasOwnProperty(e)&&delete d[e];return this};c.collides=function(a,c,b){var e,d,g,f,n,l,q;null==b&&(b=!1);null==this.collision&&(this.collision={});"function"===k.type(a)&&(a=a.objectId.toString());a=a.split(", ");f=0;for(l=a.length;f<l;f++){d=a[f];if(parseInt(d,10)===parseInt(d,10))e=this.prototype.collision[d],null==e||b?this.prototype.collision[d]=c:"function"===k.type(e)?this.prototype.collision[d]=
[e,c]:"array"===k.type(e)&&e.push(c);else for(g=h(d),n=0,q=g.length;n<q;n++)d=g[n],e=this.prototype.collision[d.objectId],null==e||b?this.prototype.collision[d.objectId]=c:"function"===k.type(e)?this.prototype.collision[d.objectId]=[e,c]:"array"===k.type(e)&&e.push(c);if(null!=m)for(n=h(this),d=0,g=n.length;d<g;d++)e=n[d],delete e.collision}return this};c.moveUp=function(a,c,b){null==a&&(a=1);null==b&&(b="up");"string"===k.type(c)&&(b=c);this.on("keydown-"+b,function(){this.vy=-a;return"function"===
typeof c?c("up"):void 0});this.on("keyup-"+b,function(){return this.vy=0});return this};c.moveDown=function(a,c,b){null==a&&(a=1);null==b&&(b="down");"string"===k.type(c)&&(b=c);this.on("keydown-"+b,function(){this.vy=a;return"function"===typeof c?c("down"):void 0});this.on("keyup-"+b,function(){return this.vy=0});return this};c.moveLeft=function(a,c,b){null==a&&(a=1);null==b&&(b="left");"string"===k.type(c)&&(b=c);this.on("keydown-"+b,function(){this.vx=-a;return"function"===typeof c?c("left"):void 0});
this.on("keyup-"+b,function(){return this.vx=0});return this};c.moveRight=function(a,c,b){null==a&&(a=1);null==b&&(b="right");"string"===k.type(c)&&(b=c);this.on("keydown-"+b,function(){this.vx=a;return"function"===typeof c?c("right"):void 0});this.on("keyup-"+b,function(){return this.vx=0});return this};c.fourDirections=function(a,c,b){null==b&&(b=["up","down","left","right"]);"array"===k.type(c)&&(b=c);this.moveUp(a,c,b[0]).moveDown(a,c,b[1]).moveLeft(a,c,b[2]).moveRight(a,c,b[3]);return this};
k.extend(c.prototype,b);c.off=function(a,c){var b,e,d,g,f,n,h,m,l,q;e=a.split(", ");f=0;for(h=e.length;f<h;f++)if(b=e[f],0===b.indexOf("collision-with-"))b=b.slice(15),"function"===typeof this.unbindCollision&&this.unbindCollision(b,c);else if(null!=c)if(c===this.prototype[b])this.prototype[b]=null;else for(l=this.prototype[b],d=n=0,m=l.length;n<m;d=++n){if(g=l[d],g===c){this.prototype[b].splice(d,1);break}}else d=this.prototype[b],"function"===k.type(d)?this.prototype[b]=null:"array"===k.type(d)&&
null!=(q=this.prototype[b])&&q.splice(0,9E9);return this};c.unbindCollision=function(a,c){var b,e,d,g,f,n,l,q,r,t,v;"function"===k.type(a)&&(a=a.objectId.toString());f=a.split(", ");v=[];n=0;for(q=f.length;n<q;n++){b=f[n];if(parseInt(b,10)===parseInt(b,10))if(d=this.prototype.collision[b],null!=c)if(d===c)this.prototype.collision[b]=null;else for(b=l=0,r=d.length;l<r;b=++l){if(g=d[b],g===c){this.prototype[event].splice(b,1);break}}else"function"===k.type(d)?this.prototype.collision[b]=null:"array"===
k.type(d)&&null!=(t=this.prototype.collision[b])&&t.splice(0,9E9);else for(b=h(b),g=0,l=b.length;g<l;g++)d=b[g],this.unbindCollision(d,c);null!=m?v.push(function(){var a,b,c,d;c=h(this);d=[];b=0;for(a=c.length;b<a;b++)e=c[b],d.push(delete e.collision);return d}.call(this)):v.push(void 0)}return v};return c}()};h.getByTags=function(){return E};h.assets=F=[];h.assetsLoaded=0;Y=[];U=function(){return new Audio||document.createElement("Audio")};D=function(){function b(a,b,c){var d,f,g,p,s,m,u=this;null==
b&&(b=3);if(aa.audio){this.unusedTracks=[];this.tracks=[];this.loadedTracks=[];"object"===k.type(a)&&(d=[a.source,a.tracks,a.onload],a=d[0],b=d[1],c=d[2]);"function"===k.type(b)&&(d=[b,5],c=d[0],b=d[1]);this.loaded=!1;this.sound=U();if("array"===k.type(a)){p=[];s=0;for(m=a.length;s<m;s++)if(g=a[s],f=g.substr(g.lastIndexOf(".")+1),d=this.sound.canPlayType("audio/"+f),"probably"===d&&"wav"!==f){a=g;break}else"maybe"!==d&&"wav"!==f||p.push(g);"array"===k.type(a)&&(a=p[0],"wav"===a.substr(a.lastIndexOf(".")+
1)&&null!=p[1]&&(a=p[1]),null==a&&(z.suppressAudioWarnings||V("No audio file formats were found applicable"),a=a[0]))}k(this.sound).on("canplaythrough",function(){var d,g,f;if(!u.loaded)if(h.assetsLoaded++,u.loaded=!0,null!=c&&c.call(u),5<u.sound.duration&&"wav"===u.sound.src.substr(u.sound.src.lastIndexOf(".")+1))u.tracks=[u.sound],u.unusedTracks=[0],z.suppressAudioWarnings||V("Wav files are too big to load many. (Only one track will be loaded.)                Convert to ogg or mp3");else for(g=
function(a){k(u.tracks[a]).on("canplaythrough",function(){u.loadedTracks[a]||(u.loadedTracks[a]=!0,h.assetsLoaded++)})},d=f=0;f<b;d=f+=1)u.unusedTracks.push(d),u.tracks[d]=U(),F.push(u.tracks[d]),g(d),u.loadedTracks[d]=!1,u.tracks[d].src=a,u.tracks[d].preload=!0});this.sound.src=a;this.sound.preload=!0;this.sound.load();F.push(this.sound)}}b.prototype.trackID=0;b.prototype.play=function(a){var b,c=this;null==a&&(a=this.trackID);if(null==this.tracks[a])z.suppressAudioWarnings||B("Not enough tracks");
else return this.tracks[a].play(),k(this.tracks[a]).on("ended pause",function(){0>y.call(c.unusedTracks,b)&&c.unusedTracks.push(b);k(c).off("ended pause");return c.trackID=c.unusedTracks[0]}),b=this.unusedTracks.splice(this.unusedTracks.indexOf(a),1)[0],this.trackID=this.unusedTracks[0],a};b.prototype.stop=function(a){var b,c,d;if(null==a)for(d=this.tracks,b=0,c=d.length;b<c;b++)a=d[b],a.pause();else this.tracks[a].pause();this.trackID=this.unusedTracks[0];return this.unusedTracks};b.prototype.loop=
function(a){var b,c=this;null==a&&(a=this.trackID);if(null==this.tracks[a])z.suppressAudioWarnings||B("Not enough tracks");else return this.tracks[a].loop=!0,this.tracks[a].play(),k(this.tracks[a]).off("ended pause").on("pause",function(){c.unusedTracks.push(b);return k(c).off("ended pause")}),b=this.unusedTracks.splice(this.unusedTracks.indexOf(a),1)[0],this.trackID=this.unusedTracks[0],a};return b}();h.Sound=D;h.playingSounds=function(){return Y};h.alarms=K=[];D=function(){function b(a,b){K.push(this);
this.onEnd=null!=b?[b]:[];this.startValue=this.value=a}b.prototype.end=function(a){this.onEnd.push(a);return this};b.prototype.startOver=function(a){null==a&&(a=this.startValue);this.value=a;return this};b.prototype.trigger=function(){var a,b,c,d;d=this.onEnd;b=0;for(c=d.length;b<c;b++)a=d[b],a.call(this);return this};return b}();h.Alarm=D;h.removeAlarm=Z=function(b){var a;a=K;if("number"===k.type(b))return a.splice(b,1);if(0>y.call(a,b))z.suppressAlarmWarnings||B("Alarm not found!");else return a.splice(a.indexOf(b),
1)};h.removeAllAlarms=function(){var b;for(b=[];this.alarms[0];)b.push(Z(0));return b};h.animation=function(b,a,e,c,d){var f,g,p;"object"===k.type(b)&&(d=b,b=d.divider,a=d.x,e=d.y,c=d.width,d=d.height,null==a&&(a=0),null==e&&(e=0));if(null==c||null==d)c=a,d=e,a=e=0;p=[];for(f=g=0;0<b?g<c:g>c;f=g+=b)p.push([a+f,e,b,d]);return p};M=function(){function b(a){var p,s,h,m,l,q,r,n,w=this;this.id=e;e++;"string"===k.type(a)&&(a={source:a});l=a.source;this.width=a.width;this.height=a.height;m=a.repeating;h=
a.onload;this.speed=a.speed;n=a._useDom;r=a.tilesize;q=a.tiles;null==m&&(m=!1);null==this.speed&&(this.speed=1);null==n&&(n=!1);null==r&&(r=1);this.screen=document.createElement(n?"div":"canvas");null!=this.width&&null!=this.height&&f(this.screen,this.width,this.height);"function"===k.type(l)?(this.type="function",this.screen=c.call(this,{fn:l,width:this.width,height:this.height,repeating:m,onload:h,speed:this.speed,_useDom:n,tilesize:r,tiles:q,screen:this.screen})):null!=q?(n&&B("Cannot use tiles with DOM elements",
!0),"array"!==k.type(q[0])?(p=q[0]*r,s=q[1]*r,this.screen.width=this.width=q[2]*r,this.screen.height=this.height=q[3]*r,w=this,new b({source:l,onload:function(){return this.draw(w.screen.getContext("2d"),-p,-s,1)}}),this.type="tileset"):(null==this.width&&(this.width=q[0][2]*r),null==this.height&&(this.height=q[0][3]*r),this.imgs=q.map(function(a){return new b({source:l,width:w.width,height:w.height,repeating:m,onload:h,speed:w.speed,_useDom:n,tilesize:r,tiles:a})}),this.imgInd=0,this.type="animation")):
"array"===k.type(l)?(this.type="animation",n&&B("Cannot create animation with DOM elements",!0),this.imgs=l.map(function(a){return new b({source:a,width:w.width,height:w.height,repeating:m,onload:h,speed:w.speed,_useDom:n,tilesize:r,tiles:q})}),this.imgInd=0):"string"===k.type(l)&&(this.type="src",d.call(this,{source:l,width:this.width,height:this.height,repeating:m,onload:h,speed:this.speed,_useDom:n,tilesize:r,tiles:q,screen:this.screen}));this.useDom=n}var a,e,c,d,f;e=0;f=function(a,b,c){return"canvas"===
a.tagName.toLowerCase()?(a.width=b,a.height=c):k(a).css({width:b,height:c,position:"absolute"})};a=function(a){var b,c;c=document.createElement("canvas");c.width=a.screen.width;c.height=a.screen.height;b=c.getContext("2d");a=b.createPattern(a.screen,!0===a.repeating?"repeat":a.repeating);b.rect(0,0,c.width,c.height);b.fillStyle=a;b.fill();return c};c=function(b){var c;b.fn(b.screen);c=b.screen;b._useDom||!1===b.repeating||(c=a(b));return c};d=function(a){var b,c,d,e=this;c=new Image;d=a.screen;a._useDom||
(b=d.getContext("2d"));c.onload=function(){var f,k;a.repeating?(a._useDom&&B("DOM elements cannot have patterns",!0),f=b.createPattern(c,!0===a.repeating?"repeat":a.repeating),b.rect(0,0,e.width,e.height),b.fillStyle=f,b.fill()):(null==e.width&&(e.width=c.width),null==e.height&&(e.height=c.height),d.width=e.width,d.height=e.height,a._useDom?d.appendChild(c):b.drawImage(c,0,0,e.width,e.height));h.assetsLoaded+=1;return null!=(k=a.onload)?k.apply(e):void 0};c.src=a.source;F.push(c);return c};b.prototype.draw=
function(a,b,c,e){var d;if(this.useDom)return d=k(".divSprite"+this.id+":eq("+(e-1)+")"),d.css({left:""+(b-m.view()[0])+"px",top:""+(c-m.view()[1])+"px"});switch(this.type){case "src":case "function":case "tileset":return a.drawImage(this.screen,b,c);case "animation":return(d=this.imgs[Math.floor(this.imgInd)]).draw.apply(d,arguments)}};b.prototype.refreshAnimation=function(a){if("animation"===this.type&&a)return this.imgInd=(this.imgInd+this.speed)%this.imgs.length};b.prototype.createDiv=function(){var a,
b;this.useDom&&(b=k(this.screen).clone(!0),b.attr("class","divSprite"+this.id),a=v?t:"body",k(a).append(b),k(b).css({position:"absolute"}))};return b}();h.Sprite=M;L=function(b,a){var e,c,d,f;if(!(b.x<a.x+a.width&&b.x+b.width>a.x&&b.y<a.y+a.height&&b.y+b.height>a.y))return!1;f=a.y+a.height-b.y;e=b.y+b.height-a.y;d=b.x+b.width-a.x;c=a.x+a.width-b.x;switch(Math.min(f,e,c,d)){case f:return"top";case e:return"bottom";case d:return"right";case c:return"left";default:return"top"}};X=function(){var b;R();
h.globalMouseX=h.globalMouseY=0;h.globalKeysdown=[];h.globalMousedown=!1;b=[];k(t).contextmenu(function(){return!1}).dblclick(function(a){return!1});S.mouseControls(function(a){h.globalMousepressed=h.globalMousedown=3===a.which?"right":"left";return!1},function(a){h.globalMousedown=!1;h.globalMouseup=3===a.which?"right":"left";return!1},function(a){h.globalMouseX=a.offsetX||a.pageX-k(this).offset().left;h.globalMouseY=a.offsetY||a.pageY-k(this).offset().top;return!1});S.keyControls(function(a){var e,
c;e=h.globalKeysdown;c=h.globalKeyspressed;a=a.which;0>y.call(e,a)&&e.push(a);0<=y.call(c,a)||0<=y.call(b,a)||(c.push(a),b.push(a));return!1},function(a){var e,c;e=h.globalKeysdown;c=h.globalKeysup;a=a.which;b.splice(b.indexOf(a),1);0>y.call(c,a)&&c.push(a);e.splice(e.indexOf(a),1);return!1})};R=function(){h.globalKeysup=[];h.globalKeyspressed=[];h.globalMousepressed=h.globalMouseup=!1};h.math={distance:function(b,a,e,c){"object"===k.type(b)&&"object"===k.type(a)?(c=[b.x,b.y,a.x,a.y],b=c[0],a=c[1],
e=c[2],c=c[3]):"object"===k.type(b)&&"number"===k.type(a)&&"number"===k.type(e)?(c=[b.x,b.y,a,e],b=c[0],a=c[1],e=c[2],c=c[3]):"number"===k.type(b)&&"number"===k.type(a)&&"object"===k.type(e)&&(c=[b,a,e.x,e.y],b=c[0],a=c[1],e=c[2],c=c[3]);return Math.sqrt((b-e)*(b-e)+(a-c)*(a-c))},intersect:function(b,a,e,c,d,f,g,h){var m,l,q,r,t,v,n,w;"object"===k.type(b)&&"object"===k.type(a)&&(l=[b,a],m=l[0],l=l[1]);"object"===k.type(b)&&k.type(a)===(t=k.type(e))&&t===(r=k.type(c))&&r===(q=k.type(d))&&"number"===
q&&(m=b,l={x:a,y:e,width:c,height:d});k.type(b)===(w=k.type(a))&&w===(n=k.type(e))&&n===(v=k.type(c))&&"number"===v&&"object"===k.type(d)&&(m={x:b,y:a,width:e,height:c},l=d);"number"===k.type(b)&&"number"===k.type(h)&&(m={x:b,y:a,width:e,height:c},l={x:d,y:f,width:g,height:h});return L(m,l)}};h.allRooms=x=[];D=function(){function b(a){var b,c,d,f,g,k;null==a&&(a={});a=[a.persistent,a.background,a.backPic,null!=(d=a.width)?d:null!=q?q:0,null!=(f=a.height)?f:null!=r?r:0,null!=(g=a.repeating)?g:!0,null!=
(k=a.useBackCanvas)?k:!0];this.persistent=a[0];this.background=a[1];b=a[2];this.w=a[3];this.h=a[4];c=a[5];this.useBackCanvas=a[6];this.toDestroy=[];this.following={};this.roomToGoTo=!1;this.allInstances=[];this.staticInst=[];this.deactivated=[];x.push(this);this.id=x.length-1;this.dynamic=[];this.trx=0;this["try"]=0;this.renderBackPic=function(){var a,d;if((this.largeBackPics=this.w>9*q&&this.h>9*r&&null!=b)&&null!=b&&!v){if(a=new Image,this.smallCan=[],d=this,a.onload=function(){var b,c,e,f,g,k,
h,m,p,l,t;h=m=0;for(l=a.width;0<q?m<l:m>l;h=m+=q)for(k=d.smallCan.length,d.smallCan.push([]),e=p=0,t=a.height;0<r?p<t:p>t;e=p+=r)b=document.createElement("canvas"),b.width=q,b.height=r,f=b.getContext("2d"),g=h+q>this.width?this.width-h:q,c=e+r>this.height?this.height-e:r,f.drawImage(this,h,e,g,c,0,0,g,c),d.smallCan[k].push(b)},c)return new M(b,this.w,this.h,c,function(){return a.src=this.c.toDataURL()})}else if(null!=b)return this.backPic=new M({source:b,width:this.w,height:this.h,repeating:c})}}
b.prototype.refreshBackground=function(){var a,b,c,d,f,g,p,l;if(this.useBackCanvas){a=G;c=a.getContext("2d");null!=this.background?(c.fillStyle=this.background,c.fillRect(0,0,a.width,a.height)):null!=this.backPic&&(this.largeBackPics?(l=m.view(),0===l[0]%q&&0===l[1]%r?c.drawImage(this.smallCan[l[0]/q][l[1]/r],l[0],l[1]):(d=Math.floor(l[0]/q),a=Math.ceil(l[0]/q),f=Math.floor(l[1]/r),b=Math.ceil(l[1]/r),c.drawImage(this.smallCan[d][f],d*q-l[0],f*r-l[1]),c.drawImage(this.smallCan[d][b],d*q-l[0],b*r-
l[1]),c.drawImage(this.smallCan[a][f],a*q-l[0],f*r-l[1]),c.drawImage(this.smallCan[a][b],a*q-l[0],b*r-l[1]))):c.drawImage(this.backPic.screen,Math.min(this.trx,this.w-q),Math.min(this["try"],this.h-r),a.width,a.height,0,0,a.width,a.height));b=function(){var a;a=function(){var a,b,c,d,e,f,g;c=arguments[0];b=arguments[1];a=3<=arguments.length?P.call(arguments,2):[];switch(k.type(c)){case "function":return c.apply(b,a);case "array":g=[];e=0;for(f=c.length;e<f;e++)d=c[e],g.push(d.apply(b,a));return g;
default:return!1}};if(null!=this.draw&&this.useBackCan)return c.save(),c.translate(this.x+this.width/2,this.y+this.height/2),c.rotate(this.imgAngle*Math.PI/180),c.translate(-(this.x+this.width/2),-(this.y+this.height/2)),c.translate(-m.trx,-m["try"]),a(this.draw,this,c),c.restore()};l=this.staticInst;d=0;for(f=l.length;d<f;d++)a=l[d],b.call(a);l=m.view();b={x:l[0],y:l[1],width:q,height:r};l=this.deactivated;d=0;for(f=l.length;d<f;d++)if(a=l[d])if(g=L(a.mask(),b))p=a.constructor,g=this.deactivated.indexOf(a),
this.deactivated.splice(g,1),a.sprite.useDom&&k(".divSprite"+a.sprite.id+":eq("+(a.id-1)+")").css("display","block"),g=h(p,this),g.push(a)}};b.prototype.refresh=function(a){var b,c,d,f,g,h,l;null==a&&(a=v?t:t.getContext("2d"));null!=this.background&&!this.useBackCanvas||v?null==this.background||this.useBackCanvas||v?this.background&&v&&k(t).css("background-color",this.background):(a.fillStyle=this.background,a.fillRect(0,0,m.w,m.h)):a.clearRect(0,0,m.w,m.h);this.useBackCanvas||v||(a.translate(-this.trx,
-this["try"]),null!=(b=this.backPic)&&"function"===typeof b.draw&&b.draw(t.getContext("2d"),0,0),a.restore());k.isEmptyObject(this.following)||(b=this.following,b.instance.y>=m.view()[1]+r-(b.borderY+b.instance.height)&&m.view()[1]<m.h-r&&m.view(0,b.speedY),b.instance.y<=m.view()[1]+b.borderY&&0<m.view()[1]&&m.view(0,-b.speedY),b.instance.x>=m.view()[0]+q-(b.borderX+b.instance.width)&&m.view()[0]<m.w-q&&m.view(b.speedX,0),b.instance.x<=m.view()[0]+b.borderX&&0<m.view()[0]&&m.view(-b.speedX,0));c=
0;for(d=K.length;c<d;c++)b=K[c],0<(null!=b?b.value:void 0)&&0===--b.value&&(b.value=-1,b.trigger());v||(a.save(),a.translate(-this.trx,-this["try"]));l=m.allInstances;d=0;for(g=l.length;d<g;d++)for(c=l[d],f=0,h=c.length;f<h;f++)b=c[f],null!=b&&"function"===typeof b.events&&b.events();v||a.restore();d=this.toDestroy;a=0;for(c=d.length;a<c;a++)b=d[a],b.destroy(!1);this.toDestroy=[];this.roomToGoTo&&($(this.roomToGoTo,!1),this.roomToGoTo=!1)};b.prototype.view=function(a,b,c){var d,f;null==a&&(a=0);null==
b&&(b=0);null==c&&(c=!0);f=[this.trx,this["try"]];d=f[0];f=f[1];c?(this.trx+=a,this["try"]+=b):(this.trx=a,this["try"]=b);c&&0===a&&0===b||!c&&a===d&&b===f||"function"===typeof this.refreshBackground&&this.refreshBackground();return[this.trx,this["try"]]};b.prototype.follow=function(a,b,c,d,f){this.following.instance=a;this.following.borderX=b;this.following.borderY=c;this.following.speedX=d;this.following.speedY=f};return b}();h.Room=D;h.roomGoto=$=function(b,a,e){var c,d,f,g,h,l;null==a&&(a=z.bufferRoomGoto);
if(a&&null!=m)switch(m.roomToGoTo=b,b){case "next":return x[m.id+1];case "previous":return x[m.id-1];default:return b}c=m;if(null!=c){l=c.allInstances;d=0;for(g=l.length;d<g;d++)for(a=l[d],f=0,h=a.length;f<h;f++)e=a[f],"function"===typeof e.roomEnd&&e.roomEnd();k("div[class^='divSprite']").remove();if(!c.persistent)for(c.allInstances=new J,a=0,e=C.length;a<e;a++)c.allInstances.push([])}switch(b){case "next":m=x[m.id+1];break;case "previous":m=x[m.id-1];break;default:m=b}"function"===typeof m.create&&
m.create();"function"===typeof m.refreshBackground&&m.refreshBackground();g=m.allInstances;b=0;for(c=g.length;b<c;b++)for(a=g[b],f=0,d=a.length;f<d;f++)e=a[f],"function"===typeof e.roomStart&&e.roomStart();return m};h.getRoom=function(){return m};window.Idea=h}).call(this);

(function(){var l,L,e,B,A,D,G,H,p,s,x,E,I,M,m,w,N,y=[].indexOf||function(c){for(var a=0,b=this.length;a<b;a++)if(a in this&&this[a]===c)return a;return-1},J=[].slice;if("undefined"===typeof jQuery||null===jQuery)throw Error("jQuery is not defined");l=jQuery;e=function(c,a,b,d){var h,g,n,k,f,z,r,C,v;f=l.type(c);k=l.type(a);h=/^(?:\d,?)+$/;g=function(a){a=a.slice(0);a.on=function(){var a,f,k;f=0;for(k=this.length;f<k;f++)a=this[f],a.on.apply(a,arguments);return this};a.collides=function(){var a,f,k;
f=0;for(k=this.length;f<k;f++)a=this[f],a.collides.apply(a,arguments);return this};return a};if(0<=y.call(e.allObjects,c)&&0<=y.call(e.allRooms,a))return a.allInstances[c.objectId];if(0<=y.call(e.allObjects,c)&&("undefined"===k||"current"===a))return e(c,e.getRoom());if("undefined"===f||"null"===f)return e.allObjects;if("number"===f&&"undefined"===k)return e.allObjects[c];if("number"===f&&"current"===a)return e(e(c));if("number"===f&&0<=y.call(e.allRooms,a))return e(e(c),a);if("string"===f)switch(c){case "iterate":return e.apply(["iterate forward"].concat([].slice.call(arguments,
1)));case "iterate forward":h=e(a,b);r=[];k=0;for(f=h.length;k<f;k++)g=h[k],r.push(d.call(g));return r;case "iterate backward":h=e(a,b);r=[];for(n=k=f=h.length;0>=f?0>k:0<k;n=0>=f?++k:--k)g=h[n-1],r.push(d.call(g));return r;default:if(h.test(c)){if("undefined"===k)return h=function(){var a,f,k,d;k=c.split(",");d=[];a=0;for(f=k.length;a<f;a++)n=k[a],d.push(e(parseInt(n,10)));return d}(),g(h);if("current"===a||0<=y.call(e.allRooms,a)){h=function(){var a,f,k,d;k=c.split(",");d=[];a=0;for(f=k.length;a<
f;a++)n=k[a],d.push(parseInt(n,10));return d}();k=E();f=0;for(r=h.length;f<r;f++)for(g=h[f],v=e(g,a),z=0,C=v.length;z<C;z++)g=v[z],k.push(g);return k}}else{if("string"===f&&"undefined"===k){h=A[c];if(null==h){e.settings.suppressTagWarnings||console.error("Bad tag name");break}return g(h)}if("string"===f&&("current"===a||0<=y.call(e.allRooms,a))){h=A[c];null==h&&(e.settings.suppressTagWarnings||console.error("Bad tag name"));k=E();r=0;for(f=h.length;r<f;r++)for(g=h[r],v=e(g,a),C=0,z=v.length;C<z;C++)g=
v[C],k.push(g);return k}throw Error("Unrecognizable arguments");}}};G=function(c){var a,b;a="space;page up;page down;end;home;left;up;right;down".split(";");b=function(){switch(c){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"ctrl";case 18:return"alt";case 20:return"caps lock";case 27:return"esc";case 45:return"insert";case 46:return"delete";case 188:return",";case 190:return".";case 191:return"/";case 192:return"`";case 219:return"[";case 220:return"\\";
case 222:return"'";default:return null}}();b||(32<=c&&40>=c&&(b=a[c-32]),48<=c&&57>=c&&(b=c-48+""),65<=c&&90>=c&&(b="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[c-65]),112<=c&&123>=c&&(b="f"+(c-111)));return b};m=null;w=!1;B=H=p=s=x=null;A={};L=function(){var c,a,b,d,e,g;b=arguments[0];d=2<=arguments.length?J.call(arguments,1):[];e=[];for(a=g=0;0<=b?g<b:g>b;a=0<=b?++g:--g)e.push({});b=0;for(g=d.length;b<g;b++)c=d[b],"fn:"===c.slice(0,3)?(c=c.slice(3),function(a){return e[a]=function(){var k,f,d,b;b=[];f=0;for(d=
this.length;f<d;f++)k=this[f],b.push(k[a].apply(k,arguments));return b}}(c)):function(d){return Object.defineProperty(e,d,{set:function(k){var f,b;f=0;for(b=this.length;f<b;f++)a=this[f],a[d]=k},get:function(a){var f;return null!=(f=this[0])?f[d]:void 0}})}(c);e.attr=function(d,k){var f,b;f=0;for(b=this.length;f<b;f++)a=this[f],a.attr.apply(a,arguments);return this};return e};E=function(){return L(0,"x","y","vx","vy","useBackCan","deactivateOut","sprite","create","begin step","draw","step","end step",
"events","collision","visible","fn:destroy","fn:moveUp","fn:moveDown","fn:moveRight","fn:moveLeft","fn:fourDirections")};e.init=function(c,a,b,d){var h,g,n,k;null==b&&(b=!1);null==d&&(d="body");b?(l(d).css({position:"absolute",width:c,height:a}),x=l(d)[0],w=!0):(k=l("<canvas width="+c+" height="+a+">").css({position:"absolute","z-index":0}),b=l("<canvas width="+c+" height="+a+">").css({position:"absolute","z-index":-1}),l(d).append(b).append(k),w=!1,d=[k[0],b[0]],x=d[0],B=d[1]);c=[c,a];s=c[0];p=c[1];
(function(){var a,k,d,b,e;a=0;d=["ms","moz","webkit","o"];b=0;for(e=d.length;b<e;b++){k=d[b];if(window.requestAnimationFrame)break;window.requestAnimationFrame=window[k+"RequestAnimationFrame"];window.cancelAnimationFrame=window[k+"CancelAnimationFrame"]||window[k+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)return window.requestAnimationFrame=function(k,d){var b,e,z;b=(new Date).getTime();z=Math.max(0,16-(b-a));e=window.setTimeout(function(){return k(b+z)},z);a=b+z;return e},window.cancelAnimationFrame=
function(a){return clearTimeout(a)}})();h=g=0;n=Date.now();this.basicFunctionsStart();b=e.allRooms;a=0;for(d=b.length;a<d;a++)c=b[a],c.renderBackPic();return H={play:function(){var a,k=this;a=function(){var d,b;g=requestAnimationFrame(a);return e.assetsLoaded===e.assets.length?(k.loaded||(k.loaded=!0,k.finishLoad()),null!=m&&m.refresh(),e.basicFunctionsEnd(),b=1E3/((d=Date.now())-n),h+=(b-h)/50,n=d):k.load(e.assetsLoaded/e.assets.length)};return g=requestAnimationFrame(a)},fps:function(){return h!==
h?h=60:h},pause:function(){return cancelAnimationFrame(g)},load:function(a){var k,d,b;k=e.getCanvasContext();k.save();k.fillStyle=e.settings.loadColor;k.strokeStyle=e.settings.loadColor;d=e.gameWidth()/2-50;b=e.gameHeight()/2-25;k.fillRect(d,b,100*a,50);k.strokeRect(d,b,100,50);return k.restore()},finishLoad:function(){return null!=m?"function"===typeof m.refreshBackground?m.refreshBackground():void 0:void 0},loaded:!1}};e.game=function(){return H};e.settings={bufferDestroy:!0,bufferRoomGoto:!0,suppressAudioWarnings:!1,
suppressTagWarnings:!1,suppressAlarmWarnings:!1,loadColor:"red"};e.support={audio:"Audio"in window,canvas:null!=(null!=(N=document.createElement("canvas"))?N.tagName:void 0)?!0:!1};e.getScreen=function(){return x};e.getCanvasContext=function(){return"function"===typeof x.getContext?x.getContext("2d"):void 0};e.getBackCanContext=function(){return"function"===typeof B.getContext?B.getContext("2d"):void 0};e.getBackgroundCanvas=function(){return B};e.gameWidth=function(){return s};e.gameHeight=function(){return p};
e.defineSettings=function(e){return l.extend(this.settings,e)};e.allObjects=[];e.gameObject=function(c,a){var b;null==a&&(a=[]);b=function(a,b,e,c,k){var f;f=e/360*2*Math.PI;e=c+(a-c)*Math.cos(2*Math.PI-f)+(b-k)*Math.sin(2*Math.PI-f);a=k-(a-c)*Math.sin(2*Math.PI-f)+(b-k)*Math.cos(2*Math.PI-f);return[e,a]};return function(){function d(a,f){var b,e,c,h;null!=(b=this.sprite)&&b.useDom&&(this.statics=this.useBackCan=!1);null!=(e=this.sprite)&&e.createDiv();null==this.width&&(this.width=null!=(c=this.sprite)?
c.width:void 0);null==this.height&&(this.height=null!=(h=this.sprite)?h.height:void 0);this.statics&&(this.useBackCan=this.deactivateOut=!0);m.allInstances[d.objectId].push(this);this.useBackCan&&m.staticInst.push(this);this.constructor=d;this.prevX=this.x=a;this.prevY=this.y=f;this.vx=this.vy=0;this.created=!1;this.imgAngle=0;this.imgScaleX=this.imgScaleY=1;this.id=m.allInstances[d.objectId].length}var h,g,n;d.prototype.statics=!1;d.prototype.sprite=null;d.prototype.visible=!0;d.prototype.width=
null;d.prototype.deactivateOut=!1;d.prototype.useBackCan=!1;d.prototype.deactivateOut=!1;d.prototype.visible=!0;d.prototype.attr=function(a,f){var b;if("string"===l.type(a))this[a]=f;else if("object"===l.type(a))for(b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);return this};d.prototype.nullified=!1;d.prototype.destroy=function(a){var f,b;null==a&&(a=e.settings.bufferDestroy);a?m.toDestroy.push(this):(a=this.constructor,null!=(f=this.sprite)&&f.useDom&&null!=(b=l(".divSprite"+this.sprite.id+":eq("+(this.id-
1)+")"))&&b.remove(),a=e(a,m),f=a.indexOf(this),0<=y.call(m.staticInst,this)&&(b=m.staticInst.indexOf(this),m.staticInst.splice(b,1)),a.splice(f,1))};d.prototype.mask=function(){var a,f,d,e,c,h;if(0===this.imgAngle)return{x:this.x,y:this.y,width:this.width,height:this.height};a=b(this.x,this.y,this.imgAngle,this.x+this.width/2,this.y+this.height/2);f=b(this.x+this.width,this.y+this.height,this.imgAngle,this.x+this.width/2,this.y+this.height/2);d=b(this.x,this.y+this.height,this.imgAngle,this.x+this.width/
2,this.y+this.height/2);e=b(this.x+this.height,this.y,this.imgAngle,this.x+this.width/2,this.y+this.height/2);c=Math.min(a[0],f[0],d[0],e[0]);h=Math.min(a[1],f[1],d[1],e[1]);return{x:c,y:h,width:Math.max(a[0],f[0],d[0],e[0])-c,height:Math.max(a[1],f[1],d[1],e[1])-h}};d.prototype.moveUp=function(a,f,b){null==a&&(a=1);null==b&&(b="up");"string"===l.type(f)&&(b=f);this["keydown-"+b]=function(){this.vy=-a;return"function"===typeof f?f("up"):void 0};this["keyup-"+b]=function(){return this.vy=0};return this};
d.prototype.moveDown=function(a,f,b){null==a&&(a=1);null==b&&(b="down");"string"===l.type(f)&&(b=f);this["keydown-"+b]=function(){this.vy=a;return"function"===typeof f?f("down"):void 0};this["keyup-"+b]=function(){return this.vy=0};return this};d.prototype.moveLeft=function(a,f,b){null==a&&(a=1);null==b&&(b="left");"string"===l.type(f)&&(b=f);this["keydown-"+b]=function(){this.vx=-a;return"function"===typeof f?f("left"):void 0};this["keyup-"+b]=function(){return this.vx=0};return this};d.prototype.moveRight=
function(a,f,b){null==a&&(a=1);null==b&&(b="right");"string"===l.type(f)&&(b=f);this["keydown-"+b]=function(){this.vx=a;return"function"===typeof f?f("right"):void 0};this["keyup-"+b]=function(){return this.vx=0};return this};d.prototype.fourDirections=function(a,b,d){null==d&&(d=["up","down","left","right"]);"array"===l.type(b)&&(d=b);this.moveUp(a,b,d[0]).moveDown(a,b,d[1]).moveLeft(a,b,d[2]).moveRight(a,b,d[3]);return this};d.prototype.stopMovement=function(){this.vx=this.vy=0;this.x=this.prevX;
return this.y=this.prevY};d.prototype.glideTo=function(a,b,d){var e,c,h;null==d&&(d=1);c=[this.x,this.y];e=c[0];c=c[1];a=e-a;b=c-b;d=Math.sqrt((a*a+b*b)/(d*d));return h=[a/d,b/d],this.vx=h[0],this.vy=h[1],h};d.prototype.draw=function(a){var b,d;null!=(b=this.sprite)&&b.draw(a,this.x,this.y,this.id);return null!=(d=this.sprite)?d.refreshAnimation(m.allInstances[this.constructor.objectId][0]===this):void 0};d.prototype.collision={};d.prototype.direction=function(a,b){null==a&&(a=this.vx);null==b&&(b=
this.vy);return(180*Math.atan2(b,a)/Math.PI+360)%360%360};d.prototype.speed=function(a,b){null==a&&(a=this.vx);null==b&&(b=this.vy);return Math.sqrt(a*a+b*b)};d.prototype.events=function(){var a,b,c,h,n,g,t,u,F,K,q=this;b=function(){var a,b,d,f,c,e,k;d=arguments[0];b=arguments[1];a=3<=arguments.length?J.call(arguments,2):[];switch(l.type(d)){case "function":return d.apply(b,a);case "array":k=[];c=0;for(e=d.length;c<e;c++)f=d[c],k.push(f.apply(b,a));return k;default:return!1}};this.created||(this.created=
!0,b(this.create,this));b(this["begin step"],this);w||(a=x.getContext("2d"));this.visible=n=D(this.mask(),function(){var a;a=m.view();return{x:a[0],y:a[1],width:s,height:p}}());if(!n&&this.deactivateOut)m.deactivated.push(this),g=e(d,m),h=g.indexOf(this),g.splice(h,1),this.sprite.useDom&&l(".divSprite"+this.sprite.id+":eq("+(this.id-1)+")").css("display","none");else{n&&(this.deactivateOut&&w)&&l(".divSprite"+this.sprite.id+":eq("+(this.id-1)+")").css("display","block");null==this.draw||this.useBackCan||
(w?b(this.draw,this,x):(a.save(),a.translate(this.x+this.width/2,this.y+this.height/2),a.rotate(this.imgAngle*Math.PI/180),a.scale(this.imgScaleX,this.imgScaleY),a.translate(-(this.x+this.width/2),-(this.y+this.height/2)),b(this.draw,this,a),a.restore()));if(this.nullified)return!1;b(this.step,this);for(c in null!=(t=this.collision)?t:{})if(this.collision.hasOwnProperty(c))for(a=e.allObjects[parseInt(c,10)],K=m.allInstances[a.objectId],t=0,u=K.length;t<u;t++)n=K[t],n.nullified||(a=D(n.mask(),this.mask()))&&
b(this.collision[c],this,n,a);(function(){var a;a=q["intersect boundary"];q.x+q.width>m.w&&b(a,q,"right");q.y+q.height>m.h&&b(a,q,"bottom");0>q.x&&b(a,q,"left");if(0>q.y)return b(a,q,"top")})();(function(){var a;a=q["outside room"];q.x>m.w&&b(a,q,"right");0>q.x+q.width&&b(a,q,"left");q.y>m.h&&b(a,q,"bottom");if(0>q.y+q.height)return b(a,q,"top")})();(function(){var a,d,c;c={x:m.view()[0],y:m.view()[1],left:m.view()[0]+s,bottom:m.view()[1]+p};a=q["intersect view"];d=q["outside view"];q.x+q.width>c.left&&
b(a,q,"right");q.y+q.height>c.bottom&&b(a,q,"bottom");q.x<c.x&&b(a,q,"left");q.y<c.y&&b(a,q,"top");q.x>c.w&&b(d,q,"right");q.x+q.width<c.x&&b(d,q,"left");q.y>c.bottom&&b(d,q,"bottom");if(q.y+q.height<c.y)return b(d,q,"top")})();t=e.globalKeysdown;a=0;for(n=t.length;a<n;a++)if(c=t[a],"function"===typeof this[c="keydown-"+G(c)])this[c]();t=e.globalKeysup;a=0;for(n=t.length;a<n;a++)if(c=t[a],"function"===typeof this[c="keyup-"+G(c)])this[c]();t=e.globalKeyspressed;a=0;for(n=t.length;a<n;a++)if(c=t[a],
"function"===typeof this[c="keypressed-"+G(c)])this[c]();if(e.globalMousedown&&"function"===typeof this[h="mousedown-"+e.globalMousedown])this[h]();if(e.globalMousepressed&&"function"===typeof this[g="mousepressed-"+e.globalMousepressed])this[g]();if(e.globalMouseup&&"function"===typeof this[F="mouseup-"+e.globalMouseup])this[F]();this.prevX=this.x;this.prevY=this.y;this.x+=this.vx;this.y+=this.vy;b(this["end step"],this)}};e.allObjects.push(d);d.objectId=e.allObjects.length-1;e.allRooms.forEach(function(a,
b,d){return d[b].allInstances.push(E())});g=0;for(n=a.length;g<n;g++)h=a[g],null!=A[h]?A[h].push(d):A[h]=[d];d.on=function(a,b,d){var c,h,n,g,u,F,p;null==d&&(d=!1);a=a.split(", ");n=0;for(u=a.length;n<u;n++)if(c=a[n],0===c.indexOf("collision-with-"))c=c.slice(15),this.collides(c,b,d);else if(h=this.prototype[c],null==h||d?this.prototype[c]=b:"function"===l.type(h)?this.prototype[c]=[h,b]:"array"===l.type(h)&&h.push(b),null!=m)for(p=e(this,"current"),g=0,F=p.length;g<F;g++)h=p[g],h.hasOwnProperty(c)&&
delete h[c];return this};d.collides=function(a,b,d){var c,h,n,g,u,p,s;null==d&&(d=!1);null==this.collision&&(this.collision={});"object"===l.type(a)&&(a=_width.objectId.toString());a=a.split(", ");g=0;for(p=a.length;g<p;g++){h=a[g];if(parseInt(h,10)===parseInt(h,10))c=this.prototype.collision[h],null==c||d?this.prototype.collision[h]=b:"function"===l.type(c)?this.prototype.collision[h]=[c,b]:"array"===l.type(c)&&c.push(b);else for(n=e(h),u=0,s=n.length;u<s;u++)h=n[u],c=this.prototype.collision[h.objectId],
null==c||d?this.prototype.collision[h.objectId]=b:"function"===l.type(c)?this.prototype.collision[h.objectId]=[c,b]:"array"===l.type(c)&&c.push(b);if(null!=m)for(u=e(this),h=0,n=u.length;h<n;h++)c=u[h],delete c.collision}return this};l.extend(d.prototype,c);return d}()};e.getByTags=function(){return A};e.assets=[];e.assetsLoaded=0;M=[];I=function(){return new Audio||document.createElement("Audio")};e.Sound=function(){function c(a,b,d){var c,g,n,k,f,m,r=this;null==b&&(b=3);if(e.support.audio){this.unusedTracks=
[];this.tracks=[];this.loadedTracks=[];"object"===l.type(a)&&(c=[a.source,a.tracks,a.onload],a=c[0],b=c[1],d=c[2]);"function"===l.type(b)&&(c=[b,5],d=c[0],b=c[1]);this.loaded=!1;this.sound=I();if("array"===l.type(a)){k=[];f=0;for(m=a.length;f<m;f++)if(n=a[f],g=n.substr(n.lastIndexOf(".")+1),c=this.sound.canPlayType("audio/"+g),"probably"===c&&"wav"!==g){a=n;break}else"maybe"!==c&&"wav"!==g||k.push(n);"array"===l.type(a)&&(a=k[0],"wav"===a.substr(a.lastIndexOf(".")+1)&&null!=k[1]&&(a=k[1]),null==a&&
(e.settings.suppressAudioWarnings||console.warn("No audio file formats were found applicable"),a=a[0]))}l(this.sound).on("canplaythrough",function(){var c,f,h;if(!r.loaded)if(e.assetsLoaded++,r.loaded=!0,null!=d&&d.call(r),5<r.sound.duration&&"wav"===r.sound.src.substr(r.sound.src.lastIndexOf(".")+1))r.tracks=[r.sound],r.unusedTracks=[0],e.settings.suppressAudioWarnings||console.warn("Wav files are too big to load many. (Only one track will be loaded.)                Convert to ogg or mp3");else for(f=
function(a){l(r.tracks[a]).on("canplaythrough",function(){r.loadedTracks[a]||(r.loadedTracks[a]=!0,e.assetsLoaded++)})},c=h=0;h<b;c=h+=1)r.unusedTracks.push(c),r.tracks[c]=I(),e.assets.push(r.tracks[c]),f(c),r.loadedTracks[c]=!1,r.tracks[c].src=a,r.tracks[c].preload=!0});this.sound.src=a;this.sound.preload=!0;this.sound.load();e.assets.push(this.sound)}}c.prototype.trackID=0;c.prototype.play=function(a){var b,d=this;null==a&&(a=this.trackID);if(null==this.tracks[a])e.settings.suppressAudioWarnings||
console.error("Not enough tracks");else return this.tracks[a].play(),l(this.tracks[a]).on("ended pause",function(){0>y.call(d.unusedTracks,b)&&d.unusedTracks.push(b);l(d).off("ended pause");return d.trackID=d.unusedTracks[0]}),b=this.unusedTracks.splice(this.unusedTracks.indexOf(a),1)[0],this.trackID=this.unusedTracks[0],a};c.prototype.stop=function(a){var b,d,c;if(null==a)for(c=this.tracks,b=0,d=c.length;b<d;b++)a=c[b],a.pause();else this.tracks[a].pause();this.trackID=this.unusedTracks[0];return this.unusedTracks};
c.prototype.loop=function(a){var b,d=this;null==a&&(a=this.trackID);if(null==this.tracks[a])e.settings.suppressAudioWarnings||console.error("Not enough tracks");else return this.tracks[a].loop=!0,this.tracks[a].play(),l(this.tracks[a]).off("ended pause").on("pause",function(){d.unusedTracks.push(b);return l(d).off("ended pause")}),b=this.unusedTracks.splice(this.unusedTracks.indexOf(a),1)[0],this.trackID=this.unusedTracks[0],a};return c}();e.playingSounds=function(){return M};e.alarms=[];e.Alarm=
function(){function c(a,b){e.alarms.push(this);this.onEnd=null!=b?[b]:[];this.startValue=this.value=a}c.prototype.end=function(a){this.onEnd.push(a);return this};c.prototype.startOver=function(a){null==a&&(a=this.startValue);this.value=a;return this};c.prototype.trigger=function(){var a,b,d,c;c=this.onEnd;b=0;for(d=c.length;b<d;b++)a=c[b],a.call(this);return this};return c}();e.removeAlarm=function(c){var a;a=e.alarms;if("number"===l.type(c))return a.splice(c,1);if(0>y.call(a,c))e.settings.suppressAlarmWarnings||
console.error("Alarm not found!");else return a.splice(a.indexOf(c),1)};e.removeAllAlarms=function(){var c;for(c=[];this.alarms[0];)c.push(this.removeAlarm(0));return c};e.animation=function(c,a,b,d,e){var g,n,k;"object"===l.type(c)&&(e=c,c=e.divider,a=e.x,b=e.y,d=e.width,e=e.height,null==a&&(a=0),null==b&&(b=0));if(null==d||null==e)d=a,e=b,a=b=0;k=[];for(g=n=0;0<c?n<d:n>d;g=n+=c)k.push([a+g,b,c,e]);return k};e.Sprite=function(){function c(a){var c,f,m,r,p,v,t,u,s=this;this.id=b;b++;"string"===l.type(a)&&
(a={source:a});p=a.source;this.width=a.width;this.height=a.height;r=a.repeating;m=a.onload;this.speed=a.speed;u=a._useDom;t=a.tilesize;v=a.tiles;null==r&&(r=!1);null==this.speed&&(this.speed=1);null==u&&(u=!1);null==t&&(t=1);this.screen=document.createElement(u?"div":"canvas");null!=this.width&&null!=this.height&&g(this.screen,this.width,this.height);if("function"===l.type(p))this.type="function",this.screen=d.call(this,{fn:p,width:this.width,height:this.height,repeating:r,onload:m,speed:this.speed,
_useDom:u,tilesize:t,tiles:v,screen:this.screen});else if(null!=v){if(u)throw Error("Cannot use tiles with DOM elements");"array"!==l.type(v[0])?(c=v[0]*t,f=v[1]*t,this.screen.width=this.width=v[2]*t,this.screen.height=this.height=v[3]*t,s=this,new e.Sprite({source:p,onload:function(){return this.draw(s.screen.getContext("2d"),-c,-f,1)}}),this.type="tileset"):(null==this.width&&(this.width=v[0][2]*t),null==this.height&&(this.height=v[0][3]*t),this.imgs=v.map(function(a){return new e.Sprite({source:p,
width:s.width,height:s.height,repeating:r,onload:m,speed:s.speed,_useDom:u,tilesize:t,tiles:a})}),this.imgInd=0,this.type="animation")}else if("array"===l.type(p)){this.type="animation";if(u)throw Error("Cannot create animation with DOM elements");this.imgs=p.map(function(a){return new e.Sprite({source:a,width:s.width,height:s.height,repeating:r,onload:m,speed:s.speed,_useDom:u,tilesize:t,tiles:v})});this.imgInd=0}else"string"===l.type(p)&&(this.type="src",h.call(this,{source:p,width:this.width,height:this.height,
repeating:r,onload:m,speed:this.speed,_useDom:u,tilesize:t,tiles:v,screen:this.screen}));this.useDom=u}var a,b,d,h,g;b=0;g=function(a,b,d){return"canvas"===a.tagName.toLowerCase()?(a.width=b,a.height=d):l(a).css({width:b,height:d,position:"absolute"})};a=function(a){var b,d;d=document.createElement("canvas");d.width=a.screen.width;d.height=a.screen.height;b=d.getContext("2d");a=b.createPattern(a.screen,!0===a.repeating?"repeat":a.repeating);b.rect(0,0,d.width,d.height);b.fillStyle=a;b.fill();return d};
d=function(b){var d;b.fn(b.screen);d=b.screen;b._useDom||!1===b.repeating||(d=a(b));return d};h=function(a){var b,d,c,h=this;d=new Image;c=a.screen;a._useDom||(b=c.getContext("2d"));d.onload=function(){var g,l;if(a.repeating){if(a._useDom)throw Error("DOM elements cannot have patterns");g=b.createPattern(d,!0===a.repeating?"repeat":a.repeating);b.rect(0,0,h.width,h.height);b.fillStyle=g;b.fill()}else null==h.width&&(h.width=d.width),null==h.height&&(h.height=d.height),c.width=h.width,c.height=h.height,
a._useDom?c.appendChild(d):b.drawImage(d,0,0,h.width,h.height);e.assetsLoaded+=1;return null!=(l=a.onload)?l.apply(h):void 0};d.src=a.source;e.assets.push(d);return d};c.prototype.draw=function(a,b,d,c){var e;if(this.useDom)return e=l(".divSprite"+this.id+":eq("+(c-1)+")"),e.css({left:""+(b-m.view()[0])+"px",top:""+(d-m.view()[1])+"px"});switch(this.type){case "src":case "function":case "tileset":return a.drawImage(this.screen,b,d);case "animation":return(e=this.imgs[Math.floor(this.imgInd)]).draw.apply(e,
arguments)}};c.prototype.refreshAnimation=function(a){if("animation"===this.type&&a)return this.imgInd=(this.imgInd+this.speed)%this.imgs.length};c.prototype.createDiv=function(){var a,b;this.useDom&&(b=l(this.screen).clone(!0),b.attr("class","divSprite"+this.id),a=w?x:"body",l(a).append(b),l(b).css({position:"absolute"}))};return c}();D=function(c,a){var b,d,e,g;if(!(c.x<a.x+a.width&&c.x+c.width>a.x&&c.y<a.y+a.height&&c.y+c.height>a.y))return!1;g=a.y+a.height-c.y;b=c.y+c.height-a.y;e=c.x+c.width-
a.x;d=a.x+a.width-c.x;switch(Math.min(g,b,d,e)){case g:return"top";case b:return"bottom";case e:return"right";case d:return"left";default:return"top"}};e.basicFunctionsStart=function(){var c;null!=e.basicFunctionsEnd();e.globalMouseX=e.globalMouseY=0;e.globalKeysdown=[];e.globalMousedown=!1;c=[];l(x).contextmenu(function(){return!1}).mousemove(function(a){e.globalMouseX=a.offsetX||a.pageX-l(this).offset().left;e.globalMouseY=a.offsetY||a.pageY-l(this).offset().top;return!1}).mousedown(function(a){e.globalMousepressed=
e.globalMousedown=3===a.which?"right":"left";return!1}).mouseup(function(a){e.globalMousedown=!1;e.globalMouseup=3===a.which?"right":"left";return!1}).dblclick(function(a){return!1});l(document).keydown(function(a){var b,d;b=e.globalKeysdown;d=e.globalKeyspressed;a=a.which;0>y.call(b,a)&&b.push(a);0<=y.call(d,a)||0<=y.call(c,a)||(d.push(a),c.push(a));return!1}).keyup(function(a){var b,d;b=e.globalKeysdown;d=e.globalKeysup;a=a.which;c.splice(c.indexOf(a),1);0>y.call(d,a)&&d.push(a);b.splice(b.indexOf(a),
1);return!1})};e.basicFunctionsEnd=function(){e.globalKeysup=[];e.globalKeyspressed=[];e.globalMousepressed=e.globalMouseup=!1};e.math={distance:function(c,a,b,d){"object"===l.type(c)&&"object"===l.type(a)?(d=[c.x,c.y,a.x,a.y],c=d[0],a=d[1],b=d[2],d=d[3]):"object"===l.type(c)&&"number"===l.type(a)&&"number"===l.type(b)?(d=[c.x,c.y,a,b],c=d[0],a=d[1],b=d[2],d=d[3]):"number"===l.type(c)&&("number"===l.type(a)&&"object"===l.type(b))&&(d=[c,a,b.x,b.y],c=d[0],a=d[1],b=d[2],d=d[3]);return Math.sqrt((c-
b)*(c-b)+(a-d)*(a-d))},intersect:function(c,a,b,d,e,g,m,k){var f,p,r,s,v,t,u,w;"object"===l.type(c)&&"object"===l.type(a)&&(p=[c,a],f=p[0],p=p[1]);"object"===l.type(c)&&(l.type(a)===(v=l.type(b))&&v===(s=l.type(d))&&s===(r=l.type(e))&&"number"===r)&&(f=c,p={x:a,y:b,width:d,height:e});l.type(c)===(w=l.type(a))&&w===(u=l.type(b))&&u===(t=l.type(d))&&"number"===t&&"object"===l.type(e)&&(f={x:c,y:a,width:b,height:d},p=e);"number"===l.type(c)&&"number"===l.type(k)&&(f={x:c,y:a,width:b,height:d},p={x:e,
y:g,width:m,height:k});return D(f,p)}};e.allRooms=[];e.Room=function(){function c(a){var b,d,c,g,l,k;null==a&&(a={});a=[a.persistent,a.background,a.backPic,null!=(c=a.width)?c:null!=s?s:0,null!=(g=a.height)?g:null!=p?p:0,null!=(l=a.repeating)?l:!0,null!=(k=a.useBackCanvas)?k:!0];this.persistent=a[0];this.background=a[1];b=a[2];this.w=a[3];this.h=a[4];d=a[5];this.useBackCanvas=a[6];this.toDestroy=[];this.following={};this.roomToGoTo=!1;this.allInstances=[];this.staticInst=[];this.deactivated=[];e.allRooms.push(this);
this.id=e.allRooms.length-1;this.dynamic=[];this.trx=0;this["try"]=0;this.renderBackPic=function(){var a,c;if((this.largeBackPics=this.w>9*s&&this.h>9*p&&null!=b)&&null!=b&&!w){if(a=new Image,this.smallCan=[],c=this,a.onload=function(){var b,d,e,h,g,k,l,m,n,w,x;l=m=0;for(w=a.width;0<s?m<w:m>w;l=m+=s)for(k=c.smallCan.length,c.smallCan.push([]),e=n=0,x=a.height;0<p?n<x:n>x;e=n+=p)b=document.createElement("canvas"),b.width=s,b.height=p,h=b.getContext("2d"),g=l+s>this.width?this.width-l:s,d=e+p>this.height?
this.height-e:p,h.drawImage(this,l,e,g,d,0,0,g,d),c.smallCan[k].push(b)},d)return new e.Sprite(b,this.w,this.h,d,function(){return a.src=this.c.toDataURL()})}else if(null!=b)return this.backPic=new e.Sprite({source:b,width:this.w,height:this.h,repeating:d})}}c.prototype.refreshBackground=function(){var a,b,d,c,g,n,k,f;if(this.useBackCanvas){a=B;d=a.getContext("2d");null!=this.background?(d.fillStyle=this.background,d.fillRect(0,0,a.width,a.height)):null!=this.backPic&&(this.largeBackPics?(f=m.view(),
0===f[0]%s&&0===f[1]%p?d.drawImage(this.smallCan[f[0]/s][f[1]/p],f[0],f[1]):(c=Math.floor(f[0]/s),a=Math.ceil(f[0]/s),g=Math.floor(f[1]/p),b=Math.ceil(f[1]/p),d.drawImage(this.smallCan[c][g],c*s-f[0],g*p-f[1]),d.drawImage(this.smallCan[c][b],c*s-f[0],b*p-f[1]),d.drawImage(this.smallCan[a][g],a*s-f[0],g*p-f[1]),d.drawImage(this.smallCan[a][b],a*s-f[0],b*p-f[1]))):d.drawImage(this.backPic.screen,Math.min(this.trx,this.w-s),Math.min(this["try"],this.h-p),a.width,a.height,0,0,a.width,a.height));b=function(){var a;
a=function(){var a,b,d,c,e,f,h;d=arguments[0];b=arguments[1];a=3<=arguments.length?J.call(arguments,2):[];switch(l.type(d)){case "function":return d.apply(b,a);case "array":h=[];e=0;for(f=d.length;e<f;e++)c=d[e],h.push(c.apply(b,a));return h;default:return!1}};if(null!=this.draw&&this.useBackCan)return d.save(),d.translate(this.x+this.width/2,this.y+this.height/2),d.rotate(this.imgAngle*Math.PI/180),d.translate(-(this.x+this.width/2),-(this.y+this.height/2)),d.translate(-m.trx,-m["try"]),a(this.draw,
this,d),d.restore()};f=this.staticInst;c=0;for(g=f.length;c<g;c++)a=f[c],b.call(a);f=m.view();b={x:f[0],y:f[1],width:s,height:p};f=this.deactivated;c=0;for(g=f.length;c<g;c++)if(a=f[c])if(n=D(a.mask(),b))k=a.constructor,n=this.deactivated.indexOf(a),this.deactivated.splice(n,1),a.sprite.useDom&&l(".divSprite"+a.sprite.id+":eq("+(a.id-1)+")").css("display","block"),n=e(k,this),n.push(a)}};c.prototype.refresh=function(a){var b,d,c,g,n,k,f;null==a&&(a=w?x:x.getContext("2d"));null!=this.background&&!this.useBackCanvas||
w?null==this.background||this.useBackCanvas||w?this.background&&w&&l(x).css("background-color",this.background):(a.fillStyle=this.background,a.fillRect(0,0,m.w,m.h)):a.clearRect(0,0,m.w,m.h);this.useBackCanvas||w||(a.translate(-this.trx,-this["try"]),null!=(b=this.backPic)&&"function"===typeof b.draw&&b.draw(x.getContext("2d"),0,0),a.restore());l.isEmptyObject(this.following)||(b=this.following,b.instance.y>=m.view()[1]+p-(b.borderY+b.instance.height)&&m.view()[1]<m.h-p&&m.view(0,b.speedY),b.instance.y<=
m.view()[1]+b.borderY&&0<m.view()[1]&&m.view(0,-b.speedY),b.instance.x>=m.view()[0]+s-(b.borderX+b.instance.width)&&m.view()[0]<m.w-s&&m.view(b.speedX,0),b.instance.x<=m.view()[0]+b.borderX&&0<m.view()[0]&&m.view(-b.speedX,0));g=e.alarms;d=0;for(c=g.length;d<c;d++)b=g[d],0<(null!=b?b.value:void 0)&&0===--b.value&&(b.value=-1,b.trigger());w||(a.save(),a.translate(-this.trx,-this["try"]));f=m.allInstances;c=0;for(n=f.length;c<n;c++)for(d=f[c],g=0,k=d.length;g<k;g++)b=d[g],null!=b&&"function"===typeof b.events&&
b.events();w||a.restore();c=this.toDestroy;a=0;for(d=c.length;a<d;a++)b=c[a],b.destroy(!1);this.toDestroy=[];this.roomToGoTo&&(e.roomGoto(this.roomToGoTo,!1),this.roomToGoTo=!1)};c.prototype.view=function(a,b,c){var e,g;null==a&&(a=0);null==b&&(b=0);null==c&&(c=!0);g=[this.trx,this["try"]];e=g[0];g=g[1];c?(this.trx+=a,this["try"]+=b):(this.trx=a,this["try"]=b);c&&0===a&&0===b||!c&&a===e&&b===g||"function"===typeof this.refreshBackground&&this.refreshBackground();return[this.trx,this["try"]]};c.prototype.follow=
function(a,b,c,e,g){this.following.instance=a;this.following.borderX=b;this.following.borderY=c;this.following.speedX=e;this.following.speedY=g};return c}();e.roomGoto=function(c,a,b){var d,h,g,n,k,f;null==a&&(a=e.settings.bufferRoomGoto);if(a&&null!=m)switch(m.roomToGoTo=c,c){case "next":return e.allRooms[m.id+1];case "previous":return e.allRooms[m.id-1];default:return c}d=m;if(null!=d){f=d.allInstances;h=0;for(n=f.length;h<n;h++)for(a=f[h],g=0,k=a.length;g<k;g++)b=a[g],"function"===typeof b.roomEnd&&
b.roomEnd();l("div[class^='divSprite']").remove();if(!d.persistent)for(d.allInstances=E(),b=e.allObjects,a=0,b=b.length;a<b;a++)d.allInstances.push([])}switch(c){case "next":m=e.allRooms[m.id+1];break;case "previous":m=e.allRooms[m.id-1];break;default:m=c}"function"===typeof m.create&&m.create();"function"===typeof m.refreshBackground&&m.refreshBackground();n=m.allInstances;c=0;for(d=n.length;c<d;c++)for(a=n[c],g=0,h=a.length;g<h;g++)b=a[g],"function"===typeof b.roomStart&&b.roomStart();return m};
e.getRoom=function(){return m};window.Idea=e}).call(this);